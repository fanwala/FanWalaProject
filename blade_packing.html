<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Blade Packing</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
.content{padding:20px}
.top-bar{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:15px;
}
h2{margin:0}

/* Buttons */
.btn{
padding:6px 12px;
border:none;
border-radius:6px;
cursor:pointer;
color:#fff;
font-size:13px;
margin-right:5px;
}
.btn-edit{background:#0d6efd}
.btn-delete{background:#dc3545}
.btn-back{background:#6c757d}
.btn-report{background:#003b8e}

.voucher{
border:1px solid #ccc;
margin-bottom:20px;
padding:10px;
background:#fff;
}

.header{
display:flex;
justify-content:space-between;
font-weight:bold;
margin-bottom:10px;
}

table{width:100%;border-collapse:collapse}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:#eee}
.total-row{font-weight:bold;background:#f5f5f5}

/* Report Modal */
.report-modal{
display:none;
position:fixed;
top:0;left:0;
width:100%;height:100%;
background:rgba(0,0,0,.6);
justify-content:center;
align-items:center;
}

.report-modal-content{
    width:420px;
    background:#003b8e;
    padding:25px;
    border-radius:10px;
    color:#fff;
    position:relative;

    max-height:85vh;
    overflow-y:auto;
}

.close-btn{
position:absolute;
top:10px;
right:15px;
cursor:pointer;
font-size:18px;
}

.field-row{
display:flex;
align-items:center;
margin-bottom:12px;
}

.side-label{
width:70px;
}

input,select{
flex:1;
padding:6px;
border-radius:5px;
border:none;
}
</style>
</head>

<body>

<div class="content">

<div class="top-bar">
<h2>Blade Packing</h2>

<div>
<button class="btn btn-back" onclick="goBack()">Back</button>
<button class="btn btn-report" onclick="openReportModal()">Reports</button>
</div>
</div>

<div id="reportContainer"></div>

</div>

<script>

function formatDate(d){
let x=new Date(d);
return String(x.getDate()).padStart(2,'0')+"-"+String(x.getMonth()+1).padStart(2,'0');
}

fetch('/api/blade_packing')
.then(res=>res.json())
.then(data=>renderReport(data));

function renderReport(data){

let container=document.getElementById("reportContainer");
container.innerHTML="";

let currentVoucher=null;
let tbody=null;

data.forEach((row,i)=>{

if(currentVoucher!==row.voucher_no){

let voucherDiv=document.createElement("div");
voucherDiv.className="voucher";

voucherDiv.innerHTML=`
<div class="header">
<span>${row.party_name}</span>
<span>${formatDate(row.received_date)} | ${formatDate(row.delivery_date)}</span>
</div>

<table>
<thead>
<tr>
<th>MODEL</th>
<th>PL/DX</th>
<th>LQ/PC</th>
<th>COLOURS</th>
<th>QTY</th>
<th>UNITS</th>
<th>BOX</th>
<th>STC</th>
<th>TRIMS</th>
<th>ACTION</th>
</tr>
</thead>
<tbody></tbody>
</table>
`;

container.appendChild(voucherDiv);
tbody=voucherDiv.querySelector("tbody");
currentVoucher=row.voucher_no;
}

let tr=document.createElement("tr");
tr.innerHTML=`
<td>${row.model_name}</td>
<td>${row.pl_dx}</td>
<td>${row.lq_pc}</td>
<td>${row.colours}</td>
<td>${row.qty}</td>
<td>${row.units}</td>
<td>${row.box||""}</td>
<td>${row.stc||""}</td>
<td>${row.trims||""}</td>
<td>
<button class="btn btn-edit" onclick="editVoucher('${row.voucher_no}')">Edit</button>
<button class="btn btn-delete" onclick="deleteVoucher('${row.voucher_no}')">Delete</button>
</td>
`;

tbody.appendChild(tr);

if(i===data.length-1 || data[i+1].voucher_no!==currentVoucher){
let totalRow=document.createElement("tr");
totalRow.className="total-row";
totalRow.innerHTML=`
<td colspan="4">TOTAL</td>
<td>${row.total_qty}</td>
<td>${row.total_units}</td>
<td colspan="4"></td>
`;
tbody.appendChild(totalRow);
}

});
}

/* ===== Edit ===== */
function editVoucher(voucherNo){
window.location.href=`edit_blade_packing.html?voucher=${voucherNo}`;
}

/* ===== Delete ===== */
function deleteVoucher(voucherNo){

if(!confirm("Are you sure you want to delete this voucher?")) return;

fetch(`/api/delete_blade_packing/${voucherNo}`,{
method:"DELETE"
})
.then(res=>res.json())
.then(data=>{
alert("Deleted successfully");
location.reload();
});
}

/* ===== Back ===== */
function goBack(){
window.location.href="index.html";
}

/* ===== Report Modal ===== */

function openReportModal(){
document.getElementById("reportModal").style.display="flex";
}

function closeReportModal(){
document.getElementById("reportModal").style.display="none";
}

function resetModal(){
document.getElementById("fromDate").value="";
document.getElementById("toDate").value="";
document.getElementById("departmentSelect").value="";
}

function openReportPage(){

const from=document.getElementById("fromDate").value;
const to=document.getElementById("toDate").value;
const dept=document.getElementById("departmentSelect").value;

if(!from || !to || !dept){
alert("Select From, To & Department");
return;
}

if(dept==="Blade Packing"){
window.location.href=`Packing_reports.html?from=${from}&to=${to}`;
}
else if(dept==="Blade Cutting"){
window.location.href=`cutting_report.html?from=${from}&to=${to}&dept=Blade Cutting`;
}
else if(dept==="Blade Painting"){
window.location.href=`painting_report.html?from=${from}&to=${to}&dept=Blade Painting`;
}
else if(dept==="Blade Powdering"){
window.location.href=`powdering_report.html?from=${from}&to=${to}&dept=Blade Powdering`;
}
}
</script>

<!-- ===== REPORT MODAL ===== -->

<div id="reportModal" class="report-modal">
<div class="report-modal-content">

<span class="close-btn" onclick="closeReportModal()">âœ–</span>

<h3 style="text-align:center;">Received Date</h3>

<div class="field-row">
<label class="side-label">From</label>
<input type="date" id="fromDate">
</div>

<div class="field-row">
<label class="side-label">To</label>
<input type="date" id="toDate">
</div>

<label>Department</label>
<select id="departmentSelect">
<option value="">Select Department</option>
<option value="Blade Packing">Blade Packing</option>
<option value="Blade Cutting">Blade Cutting</option>
<option value="Blade Painting">Blade Painting</option>
<option value="Blade Powdering">Blade Powdering</option>
<br><br>

<div style="display:flex; justify-content:space-between;">

<button class="btn btn-back" onclick="resetModal()">Reset</button>

<button class="btn btn-report" onclick="openReportPage()">Open</button>

</div>
</select>
<div style="margin-top:20px; display:flex; justify-content:space-between; gap:10px;">

    <button type="button" 
            style="flex:1; padding:8px; border:none; border-radius:6px; background:#dc3545; color:white; font-weight:bold;"
            onclick="resetModal()">
    Reset
    </button>
    
    <button type="button" 
            style="flex:1; padding:8px; border:none; border-radius:6px; background:#0d6efd; color:white; font-weight:bold;"
            onclick="openReportPage()">
    Open Report
    </button>
    
    </div>
</div>
</div>

</body>
</html>